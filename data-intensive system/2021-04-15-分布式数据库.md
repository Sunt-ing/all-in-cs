### **引言**

在大数据时代下，移动互联网、智能设备以及物联网技术的发展，使得全球数据量呈现爆发式增长，远远超出传统的单机版数据库的处理能力。近几年，分布式数据库一直是工业界和学术界的研究重点。分布式数据库应该具备强一致性、高可用性、可扩展性、易运维、容错容灾以及满足 ACID 属性的高并发事务处理能力。但在实际设计中，一方面受限于 CAP 理论 [[1](http://www.jos.org.cn/html/2019/1/5646.htm#b1)], 即，在必须支持分区容错性 (partition tolerance) 的前提下，系统实现只能侧重一致性 (consistency) 和可用性 (availability) 的一个方面而无法同时满足；另一方面，支持 ACID 事务属性及高并发事务处理一直是分布式关系数据库的难点。针对这些挑战，现有的解决策略大致可分成 3 类：(1) **将现有商业关系数据库 (如 Oracle、SQLServer、MySQL、PostgreSQL) 在分布式集群或者云平台上进行小规模扩展和部署**；(2) 放弃关系数据库模型和 ACID 的事务特性，选择灵活的 schema-free 数据模型及高可用性和最终一致性的 NoSQL 数据库；(3) 融合关系数据库和 NoSQL 优势的新型数据库 (NewSQL).

### **主要研究问题**

主流的分布式数据库基本上围绕数据强一致性、系统高可用性和 ACID 事务支持等核心问题展开研究工作，这些性质与系统的扩展性和性能密切相关，甚至相互制约，往往需要根据具体的应用需求进行取舍.

● 数据强一致性：银行交易系统等金融领域往往有数据强一致性和零丢失的需求。当更新操作完成之后，任何多个后续进程或线程的访问都要求返回最近更新值。如果在这个分布式系统中没有数据副本，那么系统必然满足数据强一致性要求，原因是只有独本数据，才不会出现数据不一致的问题。但是分布式数据库系统的设计需要保存多个副本来提高可用性和容错性，以避免宕机时数据还没有复制，导致提供的数据不够准确。如何低成本地保证数据的强一致性，是分布式数据库系统的一个重要难题；

● 系统高可用性：在分布式数据库中，系统的高可用性和数据强一致性往往不可兼得。当存在不超过 1 台机器发生故障的时候，要求至少能读到一份有效的数据，往往需要牺牲数据的强一致性来保证系统的高可用性。相当一部分 NoSQL 数据库采用这个思路来支持互联网场景下的大规模用户并发访问请求，它们通过实现最终一致性来确保高可用性和分区容忍性，弱化了数据的强一致要求。为了解决数据不一致问题，不同的分布式数据库设计各自的冲突机制。另外，有效的容错容灾机制也是保障系统高可用性的坚实后盾；

● ACID 事务支持：ACID 指的是事务层面的原子性 (atomicity)、一致性 (consistency)、隔离性 (isolation) 和持久性 (durability). 如何有效地支持 ACID 事务属性，一直是分布式数据库的难点，涉及到很多复杂的操作和逻辑，会严重影响系统的性能，很多 NoSQL 数据库都是放弃支持事务 ACID 属性来换取性能的提升。近年来，新型数据库 (NewSQL) 的出现给分布式数据库的发展带来新的方向，它的目标是提供与 NoSQL 相同的可扩展性和性能，同时支持事务的 ACID 属性。这种融合一致性和可用性的 NewSQL 已经成为分布式数据库的研究热点.

### **国内外研究现状**

#### **基于分布式集群或云平台的关系数据库**

MySQL 集群是一种常见的开源分布式数据库，它基于无共享的 (shared-nothing) 数据存储模式，采用读写分离的主从模式 (master-slave) 来实现高可用性。该设计方法也被主流的云平台关系数据库采纳和应用，包括亚马逊的 Amazon RDS (Amazon relational database service)[[2](http://www.jos.org.cn/html/2019/1/5646.htm#b2)]、谷歌的 Google Cloud SQL[[3](http://www.jos.org.cn/html/2019/1/5646.htm#b3)]、微软的 Azure SQL Database[[4](http://www.jos.org.cn/html/2019/1/5646.htm#b4)] 以及国内的阿里云 RDS[[5](http://www.jos.org.cn/html/2019/1/5646.htm#b5)]、腾讯 CDB (cloud DataBase)[[6](http://www.jos.org.cn/html/2019/1/5646.htm#b6)] 和网易的蜂巢 RDS[[7](http://www.jos.org.cn/html/2019/1/5646.htm#b7)]. 与传统数据库相比，这些云数据库往往同时支持 MySQL、SQL Server 及 PostgreSQL 等数据库引擎，具有低成本、易运维、可伸缩、高可用等优势，并提供容灾、备份、恢复、监控、迁移等数据库运维全套解决方案.

基于分布式集群或云平台关系数据库的主要缺陷是很难低成本地保持数据的一致性，每次将数据写到 master 节点后，都要及时同步 slave 节点，所以往往牺牲性能来保障强一致性。另外，如果 master 节点宕机，会直接导致业务不可写，也会影响整个系统的高可用性。为解决这一问题，MySQL 集群自带的数据同步策略从最初的异步复制进化为 MySQL 5.7 版本的半同步复制，但效果依旧有限。各大企业也纷纷设计 MySQL 补丁来保证数据一致.Amazon Aurora 将事务引擎和存储引擎分离，redo 日志从事务引擎中剥离，归并到存储引擎中，属于典型的 shared disk 架构，通过存储层共享来解决一致性问题.Galera Cluster 采用多主架构 (multi-master) 来实现真正的多点读写，即集群中每个节点都可读写，无需读写分离。集群不同节点之间数据同步是基于 Galera replication 中间件，避免了 MySQL 集群主从节点之间的复制延迟.

国内的云关系数据库也对数据一致性的提升做出了原创性贡献。阿里巴巴的 AliSQL 利用了分布式一致性协议 (Raft)[[8](http://www.jos.org.cn/html/2019/1/5646.htm#b8)] 以保障多节点状态切换的可靠性和原子性。为了保证多节点之间的 binlog 的强一致性，腾讯的 PhxSQL 使用分布式一致性协议 Paxos 实现 master 管理。同时，用 BinlogSvr 来支持 MySQL 的异步复制协议以支撑微信后台的账号系统、企业微信及 QQ 邮箱等。网易 RDS 则是采用虚拟同步复制技术，确保所有主机的更新事务在提交前都首先在从机上落盘，保证主从切换后数据完全一致。在节点上使用了并行复制技术，大幅度提高了从机回放主机事务的速度，复制延迟消失，保证了在秒级完成主从切换.

#### **NoSQL 数据库**

由于事务处理过程对 ACID 属性的严格要求，云关系数据库的可扩展性相对有限。为提升系统存储和处理海量数据的能力，NoSQL 从底层数据模型进行考虑，放弃关系模型，也不保证支持 ACID 事务处理。它采用 schema-free 的数据模型，可以根据不同应用需求衍生出多种类型的分布式数据库。按照存储模型来分类，可将 NoSQL 数据库分为列式存储 (如 HBase[[9](http://www.jos.org.cn/html/2019/1/5646.htm#b9)] 和 Cassandra[[10](http://www.jos.org.cn/html/2019/1/5646.htm#b10)])、键值存储 (如 Redis[[11](http://www.jos.org.cn/html/2019/1/5646.htm#b11)]、MemcacheDB[[12](http://www.jos.org.cn/html/2019/1/5646.htm#b12)]、DynamoDB[[13](http://www.jos.org.cn/html/2019/1/5646.htm#b13)]、SimpleDB[[14](http://www.jos.org.cn/html/2019/1/5646.htm#b14)]) 和文档存储 (如 MongoDB[[15](http://www.jos.org.cn/html/2019/1/5646.htm#b15)] 和 CouchDB[[16](http://www.jos.org.cn/html/2019/1/5646.htm#b16)]).

一个分布式系统最多同时满足一致性 (consistency, 简称 C)、可用性 (availability, 简称 A) 和分区容错性 (partition tolerance, 简称 P) 中的两项，可根据相应的设计目的进行选择。对 NoSQL 而言，分区容错性是不能牺牲的，因此只能在一致性和可用性上加以取舍。如果在这个分布式系统中数据没有副本，那么系统必然满足强一致性条件，因为只有独本数据，不会出现数据不一致的问题，此时 C 和 P 都具备。但是，如果某些服务器宕机，那必然会导致某些数据是不能访问的，那 A 就不符合了；反之，如果在这个分布式系统中数据是有副本的，那么如果某些服务器宕机，系统还是可以提供服务的，即符合 A, 但是很难保证数据的一致性。因为宕机时可能有些数据还没有复制到副本中，那么提供的数据就不准确了。一般情况下，对于一致性要求比较高的业务在访问延迟时间方面就会降低要求，适合选择 CP 模式；对于访问延时有高要求的业务在数据一致性方面会降低要求，适合选择 AP 模式.


● CP 模式

CP 模式要求分区容忍性，同时对数据一致性要求较高，即，能够保证所有用户看到相同的数据。当网络通信出现问题时，暂时隔离开的子系统可继续运行 (分区容忍性), **但是不保证某些节点故障时，所有请求都能被响应。如果主节点宕机，可能需要选举新的主节点，同步节点间数据以及进行数据回滚等操作，这会使系统的可用性降低。**常见的 CP 模式系统有 BigTable[[17](http://www.jos.org.cn/html/2019/1/5646.htm#b17)]、HBase[[9](http://www.jos.org.cn/html/2019/1/5646.htm#b9)]、Redis[[11](http://www.jos.org.cn/html/2019/1/5646.htm#b11)]、MongoDB[[15](http://www.jos.org.cn/html/2019/1/5646.htm#b15)] 和 MemcacheDB[[12](http://www.jos.org.cn/html/2019/1/5646.htm#b12)].

BigTable 是一个 GFS[[18](http://www.jos.org.cn/html/2019/1/5646.htm#b18)] 之上的索引层，采用两级的 B + 树索引结构.GFS 保证至少写入一次成功的记录并由 BigTable 记录索引。为了保证 BigTable 的强一致性，同一时刻同一份数据只能被一台机器服务，且 BigTable 中的 Tablet Server 没有对每个 Tablet 备份.HBase 是 Apache Hadoop 中的一个子项目，属于 BigTable 的开源版本，是满足强一致性的分布式数据库，主要用来存储非结构化和半结构化的松散数据.HBase 利用 Hadoop HDFS[[19](http://www.jos.org.cn/html/2019/1/5646.htm#b19)] 作为其文件存储系统，借助 MapReduce[[20](http://www.jos.org.cn/html/2019/1/5646.htm#b20)] 计算模型来处理海量数据，并使用 Zookeeper 作为分布式协同服务.HBase 使用了事务机制中常见的一致性实现方式 WAL (write-ahead logging)[[21](http://www.jos.org.cn/html/2019/1/5646.htm#b21)].

Redis 集群通常是主备，主节点负责写入和读取，而 slave 节点只是用来备份。当主节点失败时，slave 节点有机会被提升为主节点.MongoDB 采用类似于 Redis 的主从集群方式，主节点作为单点写操作服务，然后同步到 slave 节点，可以通过设置 autoresync 发现 slave 节点的数据不是最新，则自动地从主服务器请求同步数据.MongoDB 使用基于 Raft 协议选主策略，一旦主节点发生故障，整个 MongoDB 会进行交流，然后选择一个合适的 slave 节点快速实现故障恢复.

MemcacheDB 是一个新浪网基于 Memcached 开发的分布式 Key-Value 存储持久化开源项目，它使用 BerkeleyDB[[22](http://www.jos.org.cn/html/2019/1/5646.htm#b22)] 作为存储引擎，通过为 Memcached 增加 Berkeley DB 的持久化存储机制和异步主辅复制机制，使 Memcached 具备了事务恢复能力、持久化能力和分布式复制能力，非常适合超高性能读写速度和持久化保存的应用场景.

● AP 模式

AP 模式主要以实现最终一致性来确保可用性和分区容忍性，但却弱化了对数据的一致要求，大部分 NoSQL 系统都属于 AP 模式范畴.

Amazon Dynamo[[13](http://www.jos.org.cn/html/2019/1/5646.htm#b13)] 是一个分布式键值存储系统，它采用去中心化、松散耦合方式，由数百个服务组成面向服务架构，不支持复杂的查询.Dynamo 利用一致性哈希来完成数据分区，给系统中的每个节点随机分配一个 token, 这些 token 构成一个哈希环。执行数据存放操作时，首先计算 key 的哈希值，然后存放到顺时针方向第 1 个大于等于该哈希值的 token 节点上。这种算法的优点是：节点的增删只会影响哈希环中相邻的节点，对其他节点没有影响.

Cassandra[[10](http://www.jos.org.cn/html/2019/1/5646.htm#b10)] 由 Facebook 开发并于 2008 年开源，系统架构与 Dynamo 一致，均为基于 DHT (分布式哈希表) 的完全 P2P 架构，具有高度可扩展性和高度可用性，没有单点故障.Cassandra 使用由 Dynamo 引入的架构特性来支持 BigTable 数据模型，并采用 MemTable 和 SSTable 方式进行存储。在 Cassandra 写入数据之前，需要先记录日志 (CommitLog), 再将数据开始写入 ColumnFamily 对应的 MemTable 中.

Amazon SimpleDB[[14](http://www.jos.org.cn/html/2019/1/5646.htm#b14)] 是一个可大规模伸缩、用 Erlang 编写的高可用数据存储，类似于 Amazon S3, 但两者的一致性有很大的区别.Amazon S3[[23](http://www.jos.org.cn/html/2019/1/5646.htm#b23)] 一致性模型为弱一致性，只支持最基本的 Put/Get/Delete 操作，且每个操作之间是互相独立的.SimpleDB 除了支持 Get/Put/Delete, 还需要支持强一致读以及基于条件更新或者删除的乐观锁机制.Amazon S3 直接使用 “Last Write Wins” 的方式解决冲突，因为集群内部机器时钟不一致的概率很低。另外，发生同一条记录被多个客户端更新且同时发生机器故障等异常情况的概率也很低.SimpleDB 需要支持一些条件更新或者删除，从而支持乐观锁机制以实现最终一致性.

Apache CouchDB[[16](http://www.jos.org.cn/html/2019/1/5646.htm#b16)] 是一个面向文档数据管理的开源数据库，使用 JSON 存储半结构化的数据，查询语言为 JavaScript 并封装 MapReduce 和 HTTP 作为 API, 适合 CMS、电话本、地址本等的应用。其最显著的特性是支持多主复制，没有锁机制，通过使用 MVCC (多版本并发性控制)[[24](http://www.jos.org.cn/html/2019/1/5646.htm#b24)] 实现最终一致性.Tokyo Cabinet[[25](http://www.jos.org.cn/html/2019/1/5646.htm#b25)] 的开发者是日本人 Mikio Hirabayashi, 主要被用在日本最大的 SNS 网站 mixi.jp 上，也曾是键值数据库领域的热点。其他的高可用性 NoSQL 数据库还有 Voldemort[[26](http://www.jos.org.cn/html/2019/1/5646.htm#b26)]、Riak[[27](http://www.jos.org.cn/html/2019/1/5646.htm#b27)] 等 (见[表 2](http://www.jos.org.cn/html/2019/1/5646.htm#Table2)).

![image-20210415110717772](2021-04-15-%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93.assets/image-20210415110717772.png)

#### **NewSQL 数据库**

近年来，以 Spanner[[28](http://www.jos.org.cn/html/2019/1/5646.htm#b28)] 为代表的新型数据库 (NewSQL) 的出现，给数据存储和分析带来了 SQL、NoSQL 之外的新思路.NewSQL 指的是提供与 NoSQL 相同的可扩展性和性能，并同时能支持满足 ACID 特性的事务。这保留了 NOSQL 的高可扩展和高性能，且支持关系模型。融合一致性和可用性的 NewSQL 可能是未来大数据存储新的发展方向.

Spanner 是第一个将数据分布到全球规模的系统，并且在外部支持一致的分布式事务，设计目标是横跨全球上百个数据中心，覆盖百万台服务器。不同于 BigTable 版本控制的键值存储模型，Spanner 演化为时间上的多维数据库。旧版本数据根据可配置的垃圾回收政策处理，应用可以读取具有旧时间戳的数据.Spanner 显著的特点是外部一致读写和在某一时间戳的全度跨数据库一致读取。对于最典型的读写事务，Spanner 使用常见的两阶段锁策略 (2PL) 来控制并发，并实现了一个所谓的外部一致性.F1[[29](http://www.jos.org.cn/html/2019/1/5646.htm#b29)] 是 Google 公司提出的建立在 Spanner 基础上的用于广告业务的存储系统.F1 实现了丰富的关系型数据库的特点，包括严格遵从的 schema、强力的并行 SQL 查询引擎、通用事务、变更与通知的追踪和索引。其存储被动态分区，数据中心间的一致性复制能够处理数据中心崩溃引起的数据丢失.Google F1 提供了一种可能性：OLTP 与 OLAP 融合的可能性，这是在其他数据库中从未没有实现过的.

国内数据库在 NewSQL 领域的代表性系统包括阿里巴巴的 **OceanBase[[30](http://www.jos.org.cn/html/2019/1/5646.htm#b30)] 和腾讯的 DCDB**[[31](http://www.jos.org.cn/html/2019/1/5646.htm#b31)].OceanBase 是支持海量数据的高性能分布式数据库系统，实现了数千亿条记录和数百 PB 数据的跨行跨表事务。数据多副本通过 Paxos 协议同步事务日志，多数派成功事务才能提交。缺省情况下，读、写操作都在主副本进行，保证强一致。存储采用读写分离架构，没有主从结构，集群节点全对等，每个节点都具备计算和存储能力，无单点瓶颈。**腾讯 DCDB 又名 TDSQL, 是一种兼容 MySQL 协议和语法且支持自动水平拆分的高性能分布式数据库，即：业务显示为完整的逻辑表，数据却均匀地拆分到多个分片中。每个分片默认采用主备架构，提供灾备、恢复、监控、不停机扩容等全套解决方案，适用于 TB 或 PB 级的海量数据场景。**这几年，TDSQL 不断进步，研发了很多新特性，诸如多级分区、热点更新、隐含主键、分布式事务等，不仅有力地支撑了事务型数据库应用，而且在体系结构上也朝 Spanner 架构上迈进，是一个名副其实的 NewSQL 系统.

TiDB[[32](http://www.jos.org.cn/html/2019/1/5646.htm#b32)] 作为 NewSQL 开源社区的代表，是 PingCAP 公司基于 Google Spanner/F1 论文实现的开源分布式 NewSQL 数据库，能够实现分布式事务以及跨数据中心数据强一致性保证.TiDB 最底层用 Raft 来同步数据。每次写入都要写入多数副本，才能对外返回成功，即使丢掉少数副本，也能保证系统中还有最新的数据.TiDB 的事务模型采用乐观锁，只有在真正提交时才会做冲突检测，如果有冲突，则需要重试。**由于分布式事务要做两阶段提交，并且底层还需要做 Raft 复制，一个非常大的事务会使得提交过程非常慢，并且会卡住下面的 Raft 复制流程，所以在设计上，TiDB 和 Spanner 对事务的大小进行了限制.**

### **总结与展望**

本节从 CAP 理论出发，对分布式数据库的数据一致性、系统可用性和 ACID 事务属性进行了综述，并针对国内外数据库的发展状况，介绍了现有商业关系数据库如何在云平台上进行扩展和部署，NoSQL 数据库如何支持 schema-free 数据模型、高可用性和最终一致性，以及新型数据库 (NewSQL) 如何提供与 NoSQL 相同的可扩展性和性能，同时能够支持满足 ACID 特性的事务.

在大数据环境下，NoSQL 分布式数据库与传统分布式数据库的最终目标都是对用户提供完善的数据存储和查询功能，并且在运营上能够实现可伸缩和高可用等特性，并提供容灾、备份、恢复、监控等功能。两者最大的区别在于传统分布式数据库追求数据强一致性，并且需要提供 ACID 事务支持，导致其在峰值性能、伸缩性、容错性、可扩展性等方面的表现不尽如人意，很难满足海量数据的柔性管理需求.NoSQL 则是以牺牲支持 ACID 为代价，换取更好的可扩展性和可用性.NewSQL 是一种相对较新的形式，旨在将 SQL 的 ACID 保证与 NoSQL 的可扩展性和高性能相结合.

未来几年，融合关系数据库和 NoSQL 优势的 NewSQL 将继续在分布式数据库领域大放光彩，并成为一个重要的研究热点。以 OceanBase 和 DCDB 为代表的国内 NewSQL 系统也将在海量复杂业务的推动下持续发展和优化，并作为国家大数据发展战略提供有力支撑。这也意味着，我国有可能在下一波数据库技术潮流当中占领先机，进入第一梯队.















